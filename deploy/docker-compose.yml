services:
  traefik:
    image: traefik:v3.2
    command:
      - "--providers.file.filename=/etc/traefik/dynamic.yml"
      - "--providers.file.watch=true"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--api.dashboard=true"
      - "--api.insecure=true"
      - "--ping=true"
      - "--metrics.prometheus=true"
      - "--metrics.prometheus.addentrypointslabels=true"
      - "--metrics.prometheus.addrouterslabels=true"
      - "--metrics.prometheus.addserviceslabels=true"
      - "--metrics.prometheus.buckets=0.1,0.3,1.2,5.0"
      - "--tracing=true"
      - "--tracing.serviceName=traefik"
      - "--tracing.sampleRate=${TRAEFIK_TRACE_SAMPLE_RATE:-0.1}"
      - "--tracing.otlp.http=true"
      - "--tracing.otlp.http.endpoint=${TRAEFIK_OTLP_HTTP_ENDPOINT:-http://jaeger:4318/v1/traces}"
    depends_on:
      jaeger:
        condition: service_started
    ports:
      - "80:80"
      - "443:443"
      - "8081:8080"
    volumes:
      - ./traefik/dynamic.yml:/etc/traefik/dynamic.yml:ro
    networks:
      - edge
    healthcheck:
      test: ["CMD", "traefik", "healthcheck", "--ping"]
      interval: 10s
      timeout: 5s
      retries: 3

  jaeger:
    image: jaegertracing/all-in-one:latest
    restart: unless-stopped
    environment:
      COLLECTOR_OTLP_ENABLED: "true"
      SPAN_STORAGE_TYPE: "memory"
      MEMORY_MAX_TRACES: "10000"
    deploy:
      resources:
        limits:
          memory: 512m
    ports:
      - "16686:16686"
      - "4317:4317"
      - "4318:4318"
      - "14269:14269"
    networks:
      - edge
    healthcheck:
      test: ["CMD-SHELL", "wget --spider --quiet http://localhost:14269/ || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3

  prometheus:
    image: prom/prometheus:latest
    restart: unless-stopped
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--storage.tsdb.retention.time=15d"
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./prometheus/rules:/etc/prometheus/rules:ro
      - prometheus_data:/prometheus
    depends_on:
      traefik:
        condition: service_healthy
      jaeger:
        condition: service_healthy
    ports:
      - "9090:9090"
    networks:
      - edge
    healthcheck:
      test: ["CMD-SHELL", "wget --spider --quiet http://localhost:9090/-/healthy || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3

  grafana:
    image: grafana/grafana:latest
    restart: unless-stopped
    environment:
      GF_SECURITY_ADMIN_USER: "${GRAFANA_ADMIN_USER:-admin}"
      GF_SECURITY_ADMIN_PASSWORD: "${GRAFANA_ADMIN_PASSWORD:-admin}"
      GF_USERS_DEFAULT_THEME: "dark"
    volumes:
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
      - ./grafana/dashboards:/var/lib/grafana/dashboards:ro
      - grafana_data:/var/lib/grafana
    depends_on:
      prometheus:
        condition: service_healthy
    ports:
      - "3000:3000"
    networks:
      - edge
    healthcheck:
      test: ["CMD-SHELL", "wget --spider --quiet http://localhost:3000/api/health || exit 1"]
      interval: 10s
      timeout: 10s
      retries: 3

  jackett:
    image: linuxserver/jackett:latest
    restart: unless-stopped
    ports:
      - "9117:9117"
    environment:
      TZ: "UTC"
    volumes:
      - ./data/jackett:/config
    networks:
      - edge
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:9117/health || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 3

  flaresolverr:
    image: ghcr.io/flaresolverr/flaresolverr:latest
    restart: unless-stopped
    environment:
      TZ: "UTC"
      LOG_LEVEL: "info"
      PROXY_URL: "http://51.158.105.94:31826"
    ports:
      - "8191:8191"
    networks:
      - edge
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:8191/ || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 3

  prowlarr:
    image: linuxserver/prowlarr:latest
    restart: unless-stopped
    ports:
      - "9696:9696"
    environment:
      TZ: "UTC"
      DOTNET_SYSTEM_NET_HTTP_SOCKETSHTTPHANDLER_HTTP2SUPPORT: "false"
    volumes:
      - ./data/prowlarr:/config
    depends_on:
      flaresolverr:
        condition: service_healthy
    networks:
      - edge
    healthcheck:
      test: ["CMD-SHELL", "wget --spider --quiet http://localhost:9696/ping || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 3

  torrent-search:
    build:
      context: ../services/torrent-search
      dockerfile: ../../build/torrent-search.Dockerfile
    env_file:
      - ./.env
    environment:
      HTTP_ADDR: ":8090"
      LOG_LEVEL: "info"
      LOG_FORMAT: "text"
      SEARCH_TIMEOUT_SECONDS: "25"
      SEARCH_PROVIDER_PIRATEBAY_ENDPOINT: "https://apibay.org/q.php"
      SEARCH_PROVIDER_1337X_ENDPOINT: "https://x1337x.ws,https://1337x.to,https://1377x.to"
      SEARCH_PROVIDER_RUTRACKER_ENDPOINT: "https://rutracker.org/forum/tracker.php"
      SEARCH_PROVIDER_RUTRACKER_COOKIE: "${SEARCH_PROVIDER_RUTRACKER_COOKIE:-}"
      SEARCH_PROVIDER_RUTRACKER_PROXY: "${SEARCH_PROVIDER_RUTRACKER_PROXY:-}"
      FLARESOLVERR_URL: "http://flaresolverr:8191/"
      REDIS_URL: "redis://redis:6379/0"
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://jaeger:4318"
      OTEL_SERVICE_NAME: "torrent-search"
    depends_on:
      redis:
        condition: service_healthy
      jaeger:
        condition: service_started
    networks:
      - edge
      - core
    healthcheck:
      test: ["CMD-SHELL", "wget --spider --quiet http://localhost:8090/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3

  torrentstream:
    build:
      context: ../services/torrent-engine
      dockerfile: ../../build/torrent-engine.Dockerfile
    environment:
      HTTP_ADDR: ":8080"
      LOG_LEVEL: "info"
      LOG_FORMAT: "text"
      MONGO_URI: "mongodb://mongo:27017"
      MONGO_DB: "torrentstream"
      MONGO_COLLECTION: "torrents"
      TORRENT_DATA_DIR: "/data"
      TORRENT_STORAGE_MODE: "hybrid"
      TORRENT_MEMORY_LIMIT_BYTES: "1073741824"
      HLS_DIR: "/hls"
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://jaeger:4318"
      OTEL_SERVICE_NAME: "torrent-engine"
    volumes:
      - torrent_data:/data
      - hls_cache:/hls
      - anacrolix_cache:/root/.cache/anacrolix
    depends_on:
      mongo:
        condition: service_started
      jaeger:
        condition: service_started
    networks:
      - edge
      - core
    healthcheck:
      test: ["CMD-SHELL", "wget --spider --quiet http://localhost:8080/internal/health/player || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  redis:
    image: redis:7-alpine
    restart: unless-stopped
    command: ["redis-server", "--maxmemory", "256mb", "--maxmemory-policy", "allkeys-lru"]
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - core
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3

  mongo:
    image: mongo:7
    restart: unless-stopped
    ports:
      - "27017:27017"
    volumes:
      - mongo_data:/data/db
    networks:
      - core
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.runCommand('ping').ok", "--quiet"]
      interval: 10s
      timeout: 5s
      retries: 3

  web-client:
    build:
      context: ../frontend
      dockerfile: ../build/frontend.Dockerfile
      args:
        NPM_REGISTRY: "https://registry.npmmirror.com"
    volumes:
      - ./nginx/frontend.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      torrentstream:
        condition: service_healthy
      torrent-search:
        condition: service_healthy
    networks:
      - edge
    healthcheck:
      test: ["CMD-SHELL", "wget --spider --quiet http://127.0.0.1:80/ || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 3

volumes:
  mongo_data:
  torrent_data:
  hls_cache:
  anacrolix_cache:
  redis_data:
  prometheus_data:
  grafana_data:

networks:
  edge:
    name: torrentstream_edge
  core:
