x-logging: &default-logging
  driver: json-file
  options:
    max-size: "10m"
    max-file: "3"

services:
  traefik:
    image: traefik:v3.2
    logging: *default-logging
    restart: unless-stopped
    command:
      - "--providers.file.filename=/etc/traefik/dynamic.yml"
      - "--providers.file.watch=true"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--api.dashboard=true"
      - "--ping=true"
      - "--metrics.prometheus=true"
      - "--metrics.prometheus.addentrypointslabels=true"
      - "--metrics.prometheus.addrouterslabels=true"
      - "--metrics.prometheus.addserviceslabels=true"
      - "--metrics.prometheus.buckets=0.1,0.3,1.2,5.0"
      - "--tracing=true"
      - "--tracing.serviceName=traefik"
      - "--tracing.sampleRate=${TRAEFIK_TRACE_SAMPLE_RATE:-0.1}"
      - "--tracing.otlp.http=true"
      - "--tracing.otlp.http.endpoint=${TRAEFIK_OTLP_HTTP_ENDPOINT:-http://jaeger:4318/v1/traces}"
    depends_on:
      jaeger:
        condition: service_healthy
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./traefik/dynamic.yml:/etc/traefik/dynamic.yml:ro
    networks:
      - edge
    healthcheck:
      test: ["CMD", "traefik", "healthcheck", "--ping"]
      interval: 10s
      timeout: 5s
      retries: 3

  jaeger:
    image: jaegertracing/all-in-one:1.65.0
    logging: *default-logging
    restart: unless-stopped
    environment:
      COLLECTOR_OTLP_ENABLED: "true"
      SPAN_STORAGE_TYPE: "memory"
      MEMORY_MAX_TRACES: "10000"
    deploy:
      resources:
        limits:
          memory: 512m
    ports:
      - "127.0.0.1:16686:16686"
      - "127.0.0.1:4317:4317"
      - "127.0.0.1:4318:4318"
      - "127.0.0.1:14269:14269"
    networks:
      - edge
    healthcheck:
      test: ["CMD-SHELL", "wget --spider --quiet http://localhost:14269/ || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3

  prometheus:
    image: prom/prometheus:v3.2.1
    logging: *default-logging
    restart: unless-stopped
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--storage.tsdb.retention.time=15d"
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./prometheus/rules:/etc/prometheus/rules:ro
      - prometheus_data:/prometheus
    depends_on:
      traefik:
        condition: service_healthy
      jaeger:
        condition: service_healthy
    ports:
      - "127.0.0.1:9090:9090"
    networks:
      - edge
    healthcheck:
      test: ["CMD-SHELL", "wget --spider --quiet http://localhost:9090/-/healthy || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3

  grafana:
    image: grafana/grafana:11.4.0
    logging: *default-logging
    restart: unless-stopped
    environment:
      GF_SECURITY_ADMIN_USER: "${GRAFANA_ADMIN_USER:-admin}"
      GF_SECURITY_ADMIN_PASSWORD: "${GRAFANA_ADMIN_PASSWORD:-admin}"
      GF_USERS_DEFAULT_THEME: "dark"
    volumes:
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
      - ./grafana/dashboards:/var/lib/grafana/dashboards:ro
      - grafana_data:/var/lib/grafana
    depends_on:
      prometheus:
        condition: service_healthy
    ports:
      - "127.0.0.1:3000:3000"
    networks:
      - edge
    healthcheck:
      test: ["CMD-SHELL", "wget --spider --quiet http://localhost:3000/api/health || exit 1"]
      interval: 10s
      timeout: 10s
      retries: 3

  jackett:
    image: linuxserver/jackett:v0.22.1612
    logging: *default-logging
    restart: unless-stopped
    ports:
      - "127.0.0.1:9117:9117"
    environment:
      TZ: "UTC"
    volumes:
      - ./data/jackett:/config
    networks:
      - edge
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:9117/health || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 3

  flaresolverr:
    image: ghcr.io/flaresolverr/flaresolverr:v3.3.21
    logging: *default-logging
    restart: unless-stopped
    env_file:
      - ./.env
    environment:
      TZ: "UTC"
      LOG_LEVEL: "info"
      PROXY_URL: "${FLARESOLVERR_PROXY_URL:-}"
    ports:
      - "127.0.0.1:8191:8191"
    networks:
      - edge
    deploy:
      resources:
        limits:
          memory: 1g
          cpus: "1.0"
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:8191/ || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 3

  prowlarr:
    image: linuxserver/prowlarr:1.31.2
    logging: *default-logging
    restart: unless-stopped
    ports:
      - "127.0.0.1:9696:9696"
    environment:
      TZ: "UTC"
      DOTNET_SYSTEM_NET_HTTP_SOCKETSHTTPHANDLER_HTTP2SUPPORT: "false"
    volumes:
      - ./data/prowlarr:/config
    depends_on:
      flaresolverr:
        condition: service_healthy
    networks:
      - edge
    healthcheck:
      test: ["CMD-SHELL", "wget --spider --quiet http://localhost:9696/ping || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 3

  torrent-search:
    build:
      context: ../services/torrent-search
      dockerfile: ../../build/torrent-search.Dockerfile
    logging: *default-logging
    restart: unless-stopped
    env_file:
      - ./.env
    ports:
      - "8090:8090"
    environment:
      HTTP_ADDR: ":8090"
      LOG_LEVEL: "info"
      LOG_FORMAT: "text"
      SEARCH_TIMEOUT_SECONDS: "25"
      SEARCH_PROVIDER_PIRATEBAY_ENDPOINT: "https://apibay.org/q.php"
      SEARCH_PROVIDER_1337X_ENDPOINT: "https://x1337x.ws,https://1337x.to,https://1377x.to"
      SEARCH_PROVIDER_RUTRACKER_ENDPOINT: "https://rutracker.org/forum/tracker.php"
      SEARCH_PROVIDER_RUTRACKER_COOKIE: "${SEARCH_PROVIDER_RUTRACKER_COOKIE:-}"
      SEARCH_PROVIDER_RUTRACKER_PROXY: "${SEARCH_PROVIDER_RUTRACKER_PROXY:-}"
      FLARESOLVERR_URL: "http://flaresolverr:8191/"
      REDIS_URL: "redis://redis:6379/0"
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://jaeger:4318"
      OTEL_SERVICE_NAME: "torrent-search"
    depends_on:
      redis:
        condition: service_healthy
      jaeger:
        condition: service_healthy
    networks:
      - edge
      - core
    deploy:
      resources:
        limits:
          memory: 512m
          cpus: "1.0"
    healthcheck:
      test: ["CMD-SHELL", "wget --spider --quiet http://localhost:8090/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3

  torrentstream:
    build:
      context: ../services/torrent-engine
      dockerfile: ../../build/torrent-engine.Dockerfile
    logging: *default-logging
    restart: unless-stopped
    stop_grace_period: 30s
    ports:
      - "8080:8080"
    environment:
      HTTP_ADDR: ":8080"
      LOG_LEVEL: "info"
      LOG_FORMAT: "text"
      MONGO_URI: "mongodb://mongo:27017"
      MONGO_DB: "torrentstream"
      MONGO_COLLECTION: "torrents"
      TORRENT_DATA_DIR: "/data"
      HLS_DIR: "/hls"
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://jaeger:4318"
      OTEL_SERVICE_NAME: "torrent-engine"
    volumes:
      # Torrent download data â€” change host path for custom location:
      # - /path/on/host:/data
      - torrent_data:/data
      # HLS transcode working directory:
      # - /path/on/host:/hls
      - hls_cache:/hls
      - anacrolix_cache:/root/.cache/anacrolix
    depends_on:
      mongo:
        condition: service_healthy
      jaeger:
        condition: service_healthy
    networks:
      - edge
      - core
    deploy:
      resources:
        limits:
          memory: 4g
          cpus: "2.0"
        reservations:
          memory: 512m
          cpus: "0.5"
    healthcheck:
      test: ["CMD-SHELL", "wget --spider --quiet http://localhost:8080/internal/health/player || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  redis:
    image: redis:7.2.7-alpine
    logging: *default-logging
    restart: unless-stopped
    command: ["redis-server", "--maxmemory", "256mb", "--maxmemory-policy", "allkeys-lru"]
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - core
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3

  mongo:
    image: mongo:7.0.14
    logging: *default-logging
    restart: unless-stopped
    command: ["mongod", "--wiredTigerCacheSizeGB", "0.25"]
    ports:
      - "27017:27017"
    volumes:
      - mongo_data:/data/db
    networks:
      - core
    deploy:
      resources:
        limits:
          memory: 1g
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.runCommand('ping').ok", "--quiet"]
      interval: 10s
      timeout: 5s
      retries: 3

  web-client:
    build:
      context: ..
      dockerfile: build/frontend.Dockerfile
      args:
        NPM_REGISTRY: "https://registry.npmmirror.com"
    logging: *default-logging
    restart: unless-stopped
    depends_on:
      torrentstream:
        condition: service_healthy
      torrent-search:
        condition: service_healthy
    networks:
      - edge
    healthcheck:
      test: ["CMD-SHELL", "wget --spider --quiet http://127.0.0.1:80/ || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 3

  mongo-backup:
    image: mongo:7.0.14
    logging: *default-logging
    profiles: [backup]
    command: ["/scripts/mongo-backup.sh"]
    volumes:
      - ./scripts/mongo-backup.sh:/scripts/mongo-backup.sh:ro
      - mongo_backups:/backups
    environment:
      - MONGO_URI=mongodb://mongo:27017
      - DB_NAME=torrentstream
    networks:
      - core
    depends_on:
      - mongo

  mongo-backup-scheduled:
    image: mongo:7.0.14
    logging: *default-logging
    profiles: [backup-scheduled]
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        echo "Starting scheduled backup (daily at 3 AM)"
        while true; do
          NEXT=$$(date -d "tomorrow 03:00" +%s 2>/dev/null || date -v+1d -v3H -v0M -v0S +%s)
          NOW=$$(date +%s)
          SLEEP=$$((NEXT - NOW))
          echo "Next backup in $${SLEEP}s ($$(date -d @$${NEXT} 2>/dev/null || date -r $${NEXT}))"
          sleep $${SLEEP}
          /scripts/mongo-backup.sh
        done
    volumes:
      - ./scripts/mongo-backup.sh:/scripts/mongo-backup.sh:ro
      - mongo_backups:/backups
    environment:
      - MONGO_URI=mongodb://mongo:27017
      - DB_NAME=torrentstream
    networks:
      - core
    depends_on:
      - mongo
    restart: unless-stopped

volumes:
  mongo_data:
  mongo_backups:
  torrent_data:
  hls_cache:
  anacrolix_cache:
  redis_data:
  prometheus_data:
  grafana_data:

networks:
  edge:
    name: torrentstream_edge
  core:
