# Progress Log — T◎RRX

Each iteration appends a structured entry.
The coding agent reads this file at the start of every session to understand what has been done.

Format:
```
## Iteration [N] — [YYYY-MM-DD HH:MM]
**Task:** [T-XXX] [title]
**Status:** done | in_progress | blocked
**What was done:**
- ...
**Issues found:**
- ... (or "None")
**Notes for next session:**
- ...
```

---

## Iteration 1 — 2026-02-19 12:00
**Task:** [T-004] Implement domain layer with value objects and port interfaces
**Status:** done
**What was done:**
- Verified all domain value objects exist and match PRD: TorrentRecord, TorrentStatus (5 states), TorrentSource, FileRef, SessionMode (6 states + state machine), SessionState, Priority (-1 to 4), MediaInfo, MediaTrack, WatchPosition, TorrentFilter, Range
- Verified all port interfaces: Engine (14 methods), TorrentRepository (8 methods), Session (7 methods), Storage (6 methods), StreamReader (6 methods including io.ReadSeekCloser), Scheduler (2 methods)
- Verified domain error types: ErrNotFound, ErrUnsupported, ErrAlreadyExists, ErrInvalidTransition
- Verified domain purity: no external imports in domain package (only stdlib errors, time)
- Verified go vet passes clean on ./internal/domain/...
- Added missing test: TorrentPending status constant test
- Added 30-case table-driven TestCanTransition covering all 6 SessionMode states (valid + invalid transitions)
- Added 7-case TestToStatus verifying SessionMode-to-TorrentStatus mapping including unknown mode
- Added 13-case table-driven TestTorrentRecordValidate (valid, empty ID, empty status, invalid status, negative bytes, overflow, boundary cases, all 5 statuses)
- Added TestWatchPositionJSONTags, TestMediaInfoJSONTags, TestMediaTrackJSONTags
- Added TestStreamReaderInterface verifying all 6 methods (Read, Seek, Close from io.ReadSeekCloser + SetContext, SetReadahead, SetResponsive)
- All tests pass (56 domain test cases total)
**Issues found:**
- None. Domain layer was fully implemented; tests had gaps that are now filled.
**Notes for next session:**
- T-004 is done and unblocks: T-007 (anacrolix engine adapter), T-015 (SlidingPriorityReader), T-006 (MongoDB repo), T-009 (settings repos), T-024 (watch history)
- T-003 (scaffold) is also ready to verify — Go module, config, HTTP server, health endpoint all exist
- Consider T-007 or T-003 next as they are critical priority with T-004 dependency now satisfied

## Iteration 2 — 2026-02-19 14:00
**Task:** [T-003] Scaffold torrent-engine project with config and HTTP server
**Status:** done
**What was done:**
- Verified go.mod: module `torrentstream`, Go 1.25.5, all dependencies present
- Verified cmd/server/main.go (394 lines): full HTTP server with net/http.ServeMux (25+ routes), graceful shutdown on SIGTERM/SIGINT with 10s timeout, ordered component teardown (HLS manager → HTTP server → engine → MongoDB → tracer)
- Verified internal/app/config.go: parses all 22 PRD 9.1 env vars — 21 in config.go (HTTP_ADDR, MONGO_URI, MONGO_DB, MONGO_COLLECTION, TORRENT_DATA_DIR, TORRENT_MAX_SESSIONS, TORRENT_MIN_DISK_SPACE_BYTES, FFMPEG_PATH, FFPROBE_PATH, HLS_DIR, HLS_PRESET, HLS_CRF, HLS_AUDIO_BITRATE, HLS_SEGMENT_DURATION, HLS_RAMBUF_SIZE_MB, HLS_PREBUFFER_MB, HLS_WINDOW_BEFORE_MB, HLS_WINDOW_AFTER_MB, CORS_ALLOWED_ORIGINS, LOG_LEVEL, LOG_FORMAT) + OTEL_EXPORTER_OTLP_ENDPOINT in telemetry.go
- Verified health endpoint: GET /internal/health/player returns JSON with status, sessions, HLS diagnostics, issues array
- Verified middleware stack: CORS (whitelist-based), rate-limit (100 RPS/200 burst, skips health/metrics), panic recovery, structured logging, OTEL tracing
- Created internal/app/config_test.go with 6 table-driven test functions (42+ sub-tests):
  - TestLoadConfigDefaults: verifies all 22 fields have correct defaults
  - TestLoadConfigFromEnv: verifies all fields read from environment correctly
  - TestGetEnvInt64InvalidFallsBack: 7 edge cases (empty, NaN, negative, zero, valid, whitespace, float)
  - TestParseCSV: 7 edge cases (empty, whitespace, single, multiple, spaces, trailing comma, empty entries)
  - TestGetEnvFallback: existing vs missing env var
  - TestLogLevelCaseInsensitive: LOG_LEVEL case normalization
- go build ./cmd/server/ — success with zero errors
- go vet ./... — clean, zero warnings
- go test ./... — all packages pass (14 packages, no failures)
**Issues found:**
- None. Scaffold was fully implemented; only config tests were missing.
**Notes for next session:**
- T-003 is done and unblocks: T-005 (middleware), T-010 (torrent CRUD), T-019 (HLS pipeline), T-022 (direct playback), T-023 (settings API), T-024 (watch history), T-025 (WebSocket), T-026 (metrics/swagger), T-050 (OTEL tracing)
- Both T-003 and T-004 are now done. Next critical tasks with all deps satisfied:
  - T-007 (anacrolix engine adapter, critical, deps: T-004 ✅)
  - T-015 (SlidingPriorityReader, critical, deps: T-004 ✅)
  - T-006 (MongoDB repo, high, deps: T-004 ✅)
  - T-005 (middleware, medium, deps: T-003 ✅)
  - T-008 (FFprobe adapter, high, deps: T-004 ✅)
- Recommend T-007 next as it is critical priority and unblocks T-010 and T-018

## Iteration 3 — 2026-02-19 16:00
**Task:** [T-007] Implement anacrolix/torrent engine adapter
**Status:** done
**What was done:**
- Verified all 14 Engine port methods implemented: Open, Close, GetSessionState, GetSession, ListActiveSessions, StopSession, StartSession, RemoveSession, SetPiecePriority, ListSessions, FocusSession, UnfocusAll, GetSessionMode, SetDownloadRateLimit
- Verified Session implements all 7 port methods: ID, Files, SelectFile, SetPiecePriority, Start, Stop, NewReader
- Verified AddMagnet returns TorrentID as info hash hex string
- Verified NewReader returns anacrolix torrent.Reader satisfying ports.StreamReader (io.ReadSeekCloser + SetContext, SetReadahead, SetResponsive)
- Verified Focus mode: hardPauseTorrent sets DisallowDataDownload+DisallowDataUpload+SetMaxEstablishedConns(0) on non-focused torrents; resumeTorrentForStreaming re-enables data on focused torrent without DownloadAll
- Fixed defaultMaxConns from 55 to 35 per PRD specification
- Initialized focusedPieces map in New() and NewWithClient() for consistency with other map fields
- Created engine_unit_test.go with comprehensive table-driven tests (45 test cases total):
  - TestDefaultMaxConnsIs35: verifies PRD-compliant value
  - TestMapPriority: 7 cases (None, Low, Normal, Readahead, Next, High, unknown default)
  - TestTransitionValid: 18 cases covering all valid state machine transitions
  - TestTransitionInvalid: 12 cases covering all invalid transitions
  - TestTransitionSameStateIsNoop: verifies same-state is no-op
  - TestTransitionUnknownSession: verifies ErrSessionNotFound
  - TestTransitionUpdatesFocusedID: verifies focusedID cache set/clear
  - TestTransitionFocusSwitchUpdatesCache: verifies focus switch between torrents
  - TestEvictIdleSessionLocked: 4 cases (empty, LRU idle, focused protected, prefers idle)
  - TestGetSessionMode: 2 cases (not found, correct mode)
  - TestListSessions: 2 cases (empty, returns all)
  - TestListActiveSessions: excludes stopped/completed, includes active/paused
  - TestSetDownloadRateLimit: not found + get rate limit
  - TestSession*: 8 cases (ID, defensive copy, nil torrent, file selection, nil reader, nil engine)
  - TestSampleSpeedNegativeDeltaClamped: counter reset handling
  - TestStoreFocusedPieces/ForgetFocusedPieces: 4 cases (zero range, valid, cleanup, nil map)
  - TestCloseNilClient, TestTouchLastAccess: 3 edge cases
- go vet ./... — clean, zero warnings
- go test ./... — all 14 packages pass (0 failures)
**Issues found:**
- defaultMaxConns was 55 (anacrolix default) instead of 35 (PRD spec) — fixed
- focusedPieces map not initialized in constructors (inconsistent with other maps) — fixed
**Notes for next session:**
- T-007 is done and unblocks: T-010 (torrent CRUD, critical), T-012 (torrent lifecycle, high), T-018 (stream torrent, critical)
- T-003, T-004, T-007 are all done. Next critical tasks with all deps satisfied:
  - T-015 (SlidingPriorityReader, critical, deps: T-004 ✅)
  - T-006 (MongoDB repo, high, deps: T-004 ✅) — needed by T-010 and T-014
  - T-008 (FFprobe adapter, high, deps: T-004 ✅) — needed by T-021 and T-022
  - T-005 (middleware, medium, deps: T-003 ✅)
  - T-009 (settings repos, medium, deps: T-004 ✅)
- T-010 (torrent CRUD, critical) needs T-003 ✅, T-006 ❌, T-007 ✅ — T-006 is the remaining blocker
- Recommend T-006 (MongoDB repo) next to unblock T-010, or T-015 (SlidingPriorityReader) as standalone critical task

## Iteration 4 — 2026-02-19 18:00
**Task:** [T-006] Implement MongoDB torrent repository adapter
**Status:** done
**What was done:**
- Verified all 8 TorrentRepository port methods already implemented: Create, Update, UpdateProgress, Get, List, GetMany, Delete, UpdateTags
- Verified compile-time interface compliance check in interface_test.go
- Verified implementation details: BSON document models (torrentDoc, torrentUpdateDoc, fileDoc), toDoc/fromDoc conversion, normalizeTags case-insensitive dedup, mongoSortField mapping, progressOfRecord calculation, cached progress field (0.0-1.0) for efficient DB sorting
- Verified EnsureIndexes creates all 5 PRD indexes: text on name, tags, createdAt, updatedAt, progress
- Verified UpdateProgress uses atomic $max on doneBytes to prevent concurrent regression
- Verified List supports status filter, case-insensitive regex search (QuoteMeta for special chars), multi-tag AND filter ($all), sort by name/createdAt/updatedAt/totalBytes/progress, pagination via limit/offset
- Wrote 42 unit tests (table-driven, no MongoDB required):
  - TestToDocFromDocRoundtrip: full field roundtrip
  - TestToDocWithTorrentFileSource: .torrent source path
  - TestToDocEmptyFiles: empty files slice
  - TestToDocProgress: 5 cases (zero total, zero done, half, complete, large file)
  - TestToUpdateDocOmitsID: _id excluded from update doc
  - TestToUpdateDocPreservesProgress: progress calculation
  - TestToUpdateDocAllFieldsPresent: all 11 required fields
  - TestNormalizeTags: 9 cases (nil, empty, single, case-insensitive dedup, whitespace, empty removal, order, mixed, all-empty)
  - TestMongoSortField: 8 cases (5 valid fields, unknown, empty, case-sensitive)
  - TestProgressOfRecord: 6 cases (zero, negative, done, half, complete, overflow)
  - TestTimeFromUnix: 3 cases (epoch, specific, recent)
  - TestFromDocsEmpty, TestFromDocsMultiple: edge cases
  - TestToDocBSONRoundtrip: BSON serialize/deserialize integrity
  - TestToDocIDMappedTo_id: _id BSON tag mapping
  - TestEnsureIndexesNilRepository, TestEnsureIndexesNilCollection: nil safety
- Wrote 31 integration tests against real MongoDB (skip if unavailable):
  - CRUD: Create, CreateDuplicate(ErrAlreadyExists), GetRoundtrip(all fields), GetNotFound, Update, UpdateNotFound, Delete, DeleteNotFound
  - UpdateProgress: forward, $max regression (lower value preserved), higher value, NotFound, WithFiles, CachesProgressField
  - List: All, FilterStatus, Search, SearchCaseInsensitive, SearchSpecialChars, FilterTags(single+multi-AND), SortByName, SortByProgress, SortDefaultDesc, Pagination, CombinedFilters, UnknownSortFieldFallsBack
  - GetMany: normal, empty, partial match
  - UpdateTags: normal, NotFound, Normalized
  - EnsureIndexes: idempotency + 6 index verification
- go vet clean, go test ./... all 8 test packages pass (0 failures)
**Issues found:**
- None. Implementation was fully complete; only comprehensive tests were missing.
**Notes for next session:**
- T-006 is done and unblocks: T-010 (torrent CRUD, critical, deps: T-003 ✅, T-006 ✅, T-007 ✅), T-014 (SyncState, medium)
- T-003, T-004, T-006, T-007 all done. T-010 is now fully unblocked (all 3 deps satisfied)
- Next critical tasks with all deps satisfied:
  - T-010 (torrent CRUD vertical slice, critical, deps: T-003 ✅, T-006 ✅, T-007 ✅) — NOW UNBLOCKED
  - T-015 (SlidingPriorityReader, critical, deps: T-004 ✅)
  - T-008 (FFprobe adapter, high, deps: T-004 ✅) — needed by T-021 and T-022
  - T-005 (middleware, medium, deps: T-003 ✅)
  - T-009 (settings repos, medium, deps: T-004 ✅)
- Recommend T-010 next as it is now fully unblocked and is the critical torrent CRUD vertical slice

## Iteration 5 — 2026-02-19 20:00
**Task:** [T-010] Implement torrent CRUD vertical slice with API handlers
**Status:** done
**What was done:**
- Verified all CRUD operations already fully implemented: CreateTorrent (magnet JSON + multipart .torrent 5MB limit), GetTorrent, ListTorrents (status/search/tags filters, sort by 5 fields, pagination), DeleteTorrent (file cleanup + path traversal protection)
- Verified HTTP handlers in handlers_torrents.go: POST/GET /torrents, GET/DELETE /torrents/{id}, plus bulk start/stop/delete, tag management, focus/unfocus, state endpoints
- Verified use case wiring in server.go via ServerOption pattern with dependency injection
- Verified error response format: {"error":{"code":"...", "message":"..."}} per PRD 5.7
- Verified routing: handleTorrents (POST/GET), handleTorrentByID (dynamic path parsing with nested routes for actions)
- Added 18 new use case tests in control_torrent_test.go:
  - StartTorrent: engine error, repo update error, repo get error (3 new)
  - StopTorrent: not found, repo get error, engine error, repo update error, engine-not-found-ignored (5 new)
  - DeleteTorrent: keep files, not found, repo get error, engine-not-found-ignored, engine error, repo delete error, nil engine, path traversal (3 sub-cases: parent escape, empty path, platform-aware absolute path), empty data dir, missing file ignored, multiple files (10 new)
- Added 20 new use case tests in create_torrent_test.go:
  - CreateTorrent: pending when no files, custom name override, whitespace-only source, already-exists returns existing, concurrent duplicate (ErrAlreadyExists → re-fetch) (5 new)
  - Helper function tests: validateSource (both set, neither set), sumFileLengths (4 cases), deriveName (6 cases), parseInfoHash (6 cases) (5 test functions, 18 sub-cases)
- Added 30+ new handler tests in server_test.go:
  - Method routing: /torrents method not allowed, /torrents/{id} POST not allowed (2 new)
  - Create handler: engine error, bad JSON (2 new)
  - Delete handler: not found, engine error (2 new)
  - List handler: invalid sortBy/sortOrder/limit/offset, limit clamped to 1000, no repo, sort by progress (7 new)
  - Bulk operations: stop, delete, too many IDs (>100), empty IDs, invalid JSON, method not allowed, unknown action, partial failure with empty ID (8 new)
  - Utility functions: progressRatio (6 cases), parseBoolQuery (5 cases), parseStatus (7 cases), isAllowedSortBy (9 cases), parseCommaSeparated (7 cases), parseSortOrder (5 cases) (6 test functions)
  - Tags: not found, bad JSON (2 new)
  - Route edge cases: empty torrent ID, unknown action (2 new)
- go vet ./... — clean, zero warnings
- go build ./cmd/server/ — success
- go test ./... — all 8 test packages pass (0 failures)
**Issues found:**
- None. Implementation was fully complete; comprehensive tests were missing.
**Notes for next session:**
- T-010 is done and unblocks: T-011 (list view modes, medium), T-012 (torrent lifecycle, high, deps: T-007 ✅, T-010 ✅), T-013 (bulk operations, medium, deps: T-012)
- T-003, T-004, T-006, T-007, T-010 all done. Next tasks with all deps satisfied:
  - T-015 (SlidingPriorityReader, critical, deps: T-004 ✅)
  - T-012 (torrent lifecycle start/stop/focus, high, deps: T-007 ✅, T-010 ✅) — NOW UNBLOCKED
  - T-008 (FFprobe adapter, high, deps: T-004 ✅) — needed by T-021 and T-022
  - T-011 (list view modes, medium, deps: T-010 ✅) — NOW UNBLOCKED
  - T-005 (middleware, medium, deps: T-003 ✅)
  - T-009 (settings repos, medium, deps: T-004 ✅)
- Recommend T-015 next as it is critical priority and standalone, or T-012 as it is high priority and now fully unblocked

## Iteration 6 — 2026-02-19 22:00
**Task:** [T-015] Implement SlidingPriorityReader base with 4-tier gradient
**Status:** done
**What was done:**
- Verified SlidingPriorityReader fully implemented (441 lines in sliding_priority_reader.go) with all PRD 4.2 features
- Verified 4-tier gradient: [pos,+2MB)→PriorityHigh, [+2MB,+4MB)→PriorityNext, [+4MB,+~25%rem)→PriorityReadahead, rest→PriorityNormal
- Verified window sizing: readahead×4, clamped [32MB, 256MB], scales to 1% of file length for large files
- Verified boundary protection: first/last 8MB never deprioritized (MP4 moov, MKV SeekHead/Cues)
- Verified startup gradient: 4MB High + 4MB Next + graduated Readahead/Normal bands
- Verified seek boost: window doubles for 10s after seek, clamps to maxWindow
- Verified buffer-low boost: high band expands to 6MB for 5s when buffer <30%, no re-trigger while active
- Verified dynamic window: EMA α=0.3 smoothing, updated every 500ms, targets 30s buffered content
- Verified dormancy system: 60s idle threshold, enter/exit dormancy, readahead zero/restore
- Verified reader_dormancy.go (74 lines): registry register/unregister/enforceDormancy
- Created sliding_priority_reader_test.go with 50 comprehensive table-driven tests:
  - TestStreamPriorityWindow: 9 cases (default/small/large readahead, 1% scaling, max clamp, negative, zero)
  - TestApplyStartupGradient: 3 cases (4 bands, small window, medium window)
  - TestNewSlidingPriorityReaderDefaults: 5 cases (step, step clamp, backtrack clamp, negative readahead, min/max)
  - TestApplyGradientPriority: 6 cases (4 bands at offset, small/tiny/exact window, buffer-low boost 6MB, offset zero)
  - TestDeprioritizeRange: 9 cases (middle/head/tail protection, full protect, zero/negative len, span both)
  - TestUpdatePriorityWindowLocked: 3 cases (step threshold, force, deprioritize old window)
  - TestSeekBoost: 4 cases (doubles 10s, max clamp, pos update, wake dormant)
  - TestReadUpdatesPosAndPriority, TestReadWakesDormantReader, TestReadEOFPassthrough: 3 cases
  - TestAdjustWindowEMA: 6 cases (500ms throttle, first/subsequent EMA, 30s target, min clamp, seek boost skip)
  - TestBufferLowBoost: 4 cases (trigger, no trigger >30%, max clamp, no re-trigger)
  - TestCloseUnregistersFromRegistry, TestCloseWithNilRegistry: 2 cases
  - TestEnterExitDormancy: 2 cases (enter sets readahead=0, exit restores)
  - TestBoostWindowMethod: 3 cases (doubles, update calls, max clamp)
  - TestEffectiveBytesPerSec: 1 case
  - TestSetContextDelegation, TestSetReadaheadDelegation, TestSetResponsiveDelegation: 3 cases
  - TestSlidingPriorityReaderImplementsStreamReader/ReadSeekCloser: 2 interface compliance
- go vet ./... — clean, zero warnings
- go build ./cmd/server/ — success
- go test ./... — all packages pass (0 failures)
**Issues found:**
- None. Implementation was fully complete and correct per PRD; only comprehensive unit tests were missing.
**Notes for next session:**
- T-015 is done and unblocks: T-016 (adaptive boosts, medium), T-017 (SlidingPriorityReader idle/dormancy, medium), T-018 (stream torrent, critical, deps: T-007 ✅, T-015 ✅)
- T-003, T-004, T-006, T-007, T-010, T-015 all done. Next tasks with all deps satisfied:
  - T-018 (stream torrent use case, critical, deps: T-007 ✅, T-015 ✅) — NOW UNBLOCKED
  - T-012 (torrent lifecycle start/stop/focus, high, deps: T-007 ✅, T-010 ✅)
  - T-008 (FFprobe adapter, high, deps: T-004 ✅) — needed by T-021 and T-022
  - T-016 (adaptive boosts, medium, deps: T-015 ✅) — NOW UNBLOCKED
  - T-017 (idle/dormancy, medium, deps: T-015 ✅) — NOW UNBLOCKED
  - T-011 (list view modes, medium, deps: T-010 ✅)
  - T-005 (middleware, medium, deps: T-003 ✅)
  - T-009 (settings repos, medium, deps: T-004 ✅)
- Recommend T-018 next as it is critical and now fully unblocked, or T-012 as high priority

## Iteration 7 — 2026-02-19 22:15
**Task:** [T-019] Implement HLS core pipeline with FFmpeg transcoding
**Status:** done
**What was done:**
- Verified implementation fully complete across 8 source files:
  - hls_types.go: HLSConfig, qualityPresets (480p/1.5Mbps, 720p/3Mbps, 1080p/6Mbps), computeVariants(), computeProfileHash(), findLastSegment(), safeSegmentPath(), subtitleFilterArg(), buildMultiVariantFilterComplex(), parseM3U8Segments(), SeekMode, estimateByteOffset(), remuxCacheKey()
  - hls_datasource.go: MediaDataSource interface with directFileSource (completed files) and streamPipeSource (RAMBuffer for incomplete files)
  - streaming_ffmpeg.go: FFmpegArgConfig + buildStreamingFFmpegArgs pure function (single/multi-variant/stream-copy modes), FFmpegProcess wrapper with progress tracking
  - streaming_rambuf.go: RAMBuffer ring buffer (default 16MB) with exponential backoff for transient EOF, prebuffer support, context cancellation
  - streaming_manager.go (~1145 lines): StreamJobManager — job lifecycle (EnsureJob, SeekJob, StopJob, CleanupJob), encoding/HLS settings management, codec/resolution/FPS caches with LRU eviction, remux cache (MKV→MP4), health snapshot
  - streaming_fsm.go (~798 lines): 8-state FSM (Idle→Loading→Ready→Playing→Buffering→Seeking→Completed→Error), StreamJob, WindowConfig, full FSM loop with cleanup
  - streaming_priority.go: PriorityManager with 3-band priority window (High 4MB, Next 8MB, Readahead rest) + boundary protection (first/last 8MB)
  - handlers_streaming.go: HLS endpoints (master/variant playlists, segments), seek (soft/hard mode), media info, direct playback, playlist rewriting
- Verified routing in handlers_torrents.go: cases "hls", "stream", "direct", "media" all properly wired
- Created comprehensive test suite hls_test.go (~1520 lines, 57+ test functions):
  - hls_types.go tests: computeProfileHash (3), computeVariants (7), qualityPresetValues, playlistHasEndList (3), safeSegmentPath (5), subtitleFilterArg (5), buildMultiVariantFilterComplex (2), parseM3U8Segments (3), estimateByteOffset (8), seekModeString (3), remuxCacheKey, findLastSegment (5)
  - streaming_ffmpeg.go tests: buildStreamingFFmpegArgs — single variant, stream copy (AAC/non-AAC), multi-variant, seek, subtitles, default seg dur, HTTP input, audio track, FPS keyframes (10 tests)
  - streaming_rambuf.go tests: basic read/write, prebuffer, clear, close, default size, context cancellation (6 tests)
  - streaming_fsm.go tests: StreamState.String() (9), DefaultWindowConfig, StreamJob.IsRunning (8), IsCompleted, signalReady, checkSeekRequested, StartPlayback idempotent (7 tests)
  - streaming_priority.go tests: Apply, Deprioritize, nil engine, zero length, EnhanceHigh, boundary protection with mockEngine (6 tests)
  - streaming_manager.go tests: encoding settings, defaults, HLS settings, profile hash, buildJobDir, healthSnapshot, shutdown, EnsureJob nil stream, countRunningJobs, chooseSeekMode (10 tests)
  - hls_datasource.go tests: directFileSource (2), streamPipeSource, dataSourceFilePath (4 tests)
  - handlers_streaming.go tests: rewritePlaylistSegmentURLs (4 sub-tests), HTTP handler tests — not configured, invalid file index, too few path segments, seek missing/invalid/negative time, seek method not allowed, segment path traversal (11 tests)
- go vet ./... — clean, zero warnings
- go build ./cmd/server/ — success
- go test ./... — all packages pass (0 failures)
**Issues found:**
- None. Implementation was fully complete and correct per PRD; only comprehensive unit tests were missing.
**Notes for next session:**
- T-019 is done and unblocks: T-020 (HLS seek/watchdog/FSM, high, deps: T-019 ✅), T-021 (FFprobe media analysis, high, deps: T-008, T-019 ✅)
- T-003, T-004, T-006, T-007, T-010, T-015, T-018, T-019 all done. Next tasks with all deps satisfied:
  - T-020 (HLS seek/watchdog/FSM, high, deps: T-019 ✅) — NOW UNBLOCKED
  - T-012 (torrent lifecycle start/stop/focus, high, deps: T-007 ✅, T-010 ✅)
  - T-008 (FFprobe adapter, high, deps: T-004 ✅) — needed by T-021 and T-022
  - T-016 (adaptive boosts, medium, deps: T-015 ✅)
  - T-017 (idle/dormancy, medium, deps: T-015 ✅)
  - T-011 (list view modes, medium, deps: T-010 ✅)
  - T-005 (middleware, medium, deps: T-003 ✅)
  - T-009 (settings repos, medium, deps: T-004 ✅)
- Recommend T-020 next as it is high priority and now fully unblocked, or T-008 as it unblocks T-021 and T-022

## Iteration 8 — 2026-02-19 23:00
**Task:** [T-035] Scaffold frontend with Vite, routing, API client, design system, and UI kit
**Status:** done
**What was done:**
- Verified frontend scaffold already fully implemented — no code changes needed
- Confirmed package.json: React 18.3.1, TypeScript 5.6.3, Vite 5.4.10, React Router DOM 7.13.0, Tailwind CSS 3.4.17, Radix UI primitives, clsx+tailwind-merge, hls.js, lucide-react
- Confirmed vite.config.ts: proxy /torrents→:8080, /search→:8090 (env-configurable), plus /settings/*, /watch-history, /swagger, /ws
- Confirmed App.tsx: 5 routes (/, /discover, /watch/:torrentId/:fileIndex?, /settings, /diagnostics) with lazy-loaded PlayerPage and catch-all redirect
- Confirmed api.ts: fetch-based client with GET dedup (inflightGets Map), 3 timeout tiers (15s/7s/90s), AbortController, ApiRequestError class, SSE support
- Confirmed design-system.ts: light/dark themes, 7 accent presets (indigo/blue/teal/green/orange/rose/violet) + custom hex, applyAccentToRoot()
- Confirmed cn.ts: clsx + tailwind-merge utility
- Confirmed globals.css: CSS variables for :root/.dark, ts-dropdown-trigger/panel/item, app-backdrop, scrollbar, animations
- Confirmed all 12 UI components: button, card, input, select, multi-select, dropdown-menu, dialog, switch, tabs, badge, alert, textarea
- Confirmed ThemeAccentProvider, ToastProvider, Header, ErrorBoundary all present
- Ran npm install, npx tsc --noEmit (0 errors), npm run build (success, 21.86s)
**Issues found:**
- None. Implementation was complete.
**Notes for next session:**
- T-035 is done and unblocks: T-036 (CatalogPage, critical, deps: T-035 ✅, T-010 ✅), T-037 (SearchPage, high, deps: T-035 ✅, T-034 ❌), T-039 (PlayerPage, critical, deps: T-035 ✅, T-019 ✅), T-042 (SettingsPage encoding, medium), T-043 (SettingsPage providers, medium), T-044 (DiagnosticsPage, low), T-045 (WebSocket integration, medium)
- 9 tasks now done: T-003, T-004, T-006, T-007, T-010, T-015, T-018, T-019, T-035
- Next tasks with all deps satisfied:
  - T-036 (CatalogPage, critical, deps: T-035 ✅, T-010 ✅) — NOW UNBLOCKED
  - T-039 (PlayerPage, critical, deps: T-035 ✅, T-019 ✅) — NOW UNBLOCKED
  - T-020 (HLS seek/watchdog, high, deps: T-019 ✅)
  - T-012 (torrent lifecycle, high, deps: T-007 ✅, T-010 ✅)
  - T-008 (FFprobe adapter, high, deps: T-004 ✅)
  - T-027 (scaffold torrent-search, high, deps: [])
- Recommend T-036 or T-039 next as they are critical and newly unblocked

## Iteration 9 — 2026-02-19 23:30
**Task:** [T-036] Implement CatalogPage with torrent list and management
**Status:** done
**What was done:**
- Verified all 7 components already fully implemented — no code changes needed
- CatalogPage.tsx (203 lines): root page with selected torrent state, auto-refresh, navigation, bulk selection, tag management
- TorrentList.tsx (517 lines): status filter tabs (All/Active/Completed/Stopped), text search, tag filter with autocomplete, sort controls (5 fields + asc/desc), bulk select with start/stop/delete, torrent tiles with PieceBar progress, speed badges, peer count, resume chips
- TorrentDetails.tsx (265 lines): side panel with torrent info + PieceBar, session state (speed/peers), Start/Stop/Delete controls, dates, tag management, files list with per-file progress
- AddTorrentModal.tsx (172 lines): dialog with Magnet tab (textarea) + File tab (upload), optional name, error handling, API integration
- PieceBar.tsx (126 lines): canvas-based piece bitfield visualization, responsive with ResizeObserver, high DPI support
- TagInput.tsx (151 lines): comma-separated input, autocomplete suggestions, removable chips, keyboard support
- useTorrents.ts (517 lines): REST polling (5s/60s) + WebSocket, filtering/sorting, bulk/individual operations, circuit breaker, status counts
- Ran npx tsc --noEmit — 0 errors
- Ran npm run build — success (13.90s)
**Issues found:**
- None. Implementation was complete.
**Notes for next session:**
- T-036 is done and unblocks: T-046 (e2e integration, high, deps: T-036 ✅, T-037 ❌, T-039 ❌)
- 10 tasks now done: T-003, T-004, T-006, T-007, T-010, T-015, T-018, T-019, T-035, T-036
- Next tasks with all deps satisfied:
  - T-039 (PlayerPage, critical, deps: T-035 ✅, T-019 ✅) — CRITICAL, UNBLOCKED
  - T-008 (FFprobe adapter, high, deps: T-004 ✅)
  - T-012 (torrent lifecycle, high, deps: T-007 ✅, T-010 ✅)
  - T-020 (HLS seek/watchdog, high, deps: T-019 ✅)
  - T-027 (scaffold torrent-search, high, deps: [])
  - T-005 (middleware, medium, deps: T-003 ✅)
  - T-009 (settings repos, medium, deps: T-004 ✅)
  - T-011 (list view modes, medium, deps: T-010 ✅)
  - T-014 (SyncState, medium, deps: T-006 ✅, T-007 ✅)
  - T-016 (adaptive boosts, medium, deps: T-015 ✅)
  - T-017 (dormancy, medium, deps: T-015 ✅)
- Recommend T-039 next as it is the remaining critical task with all deps satisfied

## Iteration 10 — 2026-02-19 24:00
**Task:** [T-039] Implement PlayerPage with core HLS.js video playback
**Status:** done
**What was done:**
- Verified all 4 core files already fully implemented — no code changes needed
- PlayerPage.tsx (601 lines): route /watch/:torrentId/:fileIndex?, auto-start + focus torrent, watch history resume (server + localStorage merge), torrent info dialog, files panel, player health polling
- VideoPlayer.tsx (1628 lines): full HLS.js lifecycle (loadSource, attachMedia, MANIFEST_PARSED/LEVEL_SWITCHED/ERROR events), quality level tracking, error recovery with auto-retry, prebuffer phase integration, seek status overlay, auto-advance, keyboard shortcuts, watch position save, fullscreen, screenshot, auto-hide controls, timeline preview
- VideoControls.tsx (384 lines): play/pause, prev/next file, skip ±10s, mute/volume, time display, Settings dropdown (audio/subtitle tracks), Speed dropdown (0.25x–2x), Quality dropdown (Auto + levels), Info, Screenshot, Fullscreen
- useVideoPlayer.ts (747 lines): manages file selection, audio/subtitle tracks, media info polling, seek offset, prebuffer probe logic (direct → direct playback → HLS with retry), hlsSeekTo with debounce + soft/hard modes, track switch with HLS rebuild, fallback to HLS on decode errors
- Ran npx tsc --noEmit — 0 errors
- Ran npm run build — success (10.55s)
**Issues found:**
- None. Implementation was complete.
**Notes for next session:**
- T-039 is done. No more critical tasks remain with all deps satisfied.
- 11 tasks now done: T-003, T-004, T-006, T-007, T-010, T-015, T-018, T-019, T-035, T-036, T-039
- Next tasks with all deps satisfied:
  - T-008 (FFprobe adapter, high, deps: T-004 ✅)
  - T-012 (torrent lifecycle, high, deps: T-007 ✅, T-010 ✅)
  - T-020 (HLS seek/watchdog, high, deps: T-019 ✅)
  - T-027 (scaffold torrent-search, high, deps: [])
  - T-005 (middleware, medium, deps: T-003 ✅)
  - T-009 (settings repos, medium, deps: T-004 ✅)
  - T-011 (list view modes, medium, deps: T-010 ✅)
  - T-014 (SyncState, medium, deps: T-006 ✅, T-007 ✅)
  - T-016 (adaptive boosts, medium, deps: T-015 ✅)
  - T-017 (dormancy, medium, deps: T-015 ✅)
- Recommend T-008, T-012, or T-020 next as they are high priority with all deps satisfied

## Iteration 11 — 2026-02-20 00:00
**Task:** [T-008] Implement FFprobe media analysis adapter
**Status:** done
**What was done:**
- Verified FFprobe adapter already fully implemented in ffprobe.go (206 lines)
- Prober struct wraps ffprobe binary with Probe(ctx, filePath) and ProbeReader(ctx, reader) methods
- parseProbeOutput extracts video/audio/subtitle tracks with per-type indexing, codec, language, title, default flag, duration, startTime
- Handles partially-downloaded files (ffprobe non-zero exit but valid metadata kept)
- 30s default timeout with context deadline support
- getTag does case-insensitive tag lookup (exact → UPPER → lower)
- Cache layer in handlers_streaming.go: mediaProbeCacheKey (torrentID+fileIndex), mediaProbeCacheEntry with expiresAt, 5-minute TTL
- lookupMediaProbeCache/storeMediaProbeCache/invalidateMediaProbeCache methods on Server
- SubtitlesReady dynamically recomputed on cache hit via os.Stat
- Codec compatibility (H.264+AAC) tracked in streaming_manager.go codecCache (isH264/isAAC)
- Uncommitted improvements found: refactored parseProbeOutput (extracted from inline struct) + ~420 lines of new comprehensive tests
- All 20 test functions pass: empty path, nil reader, case-insensitive tags, binary defaults, full track parsing, H264+AAC detection, HEVC non-compatibility, audio-only, no tracks, empty streams, unknown types, duration edge cases, invalid JSON, multiple video tracks, independent indexing, whitespace trimming, startTime, null JSON, minimal valid, non-existent binary, timeout, plus integration tests
- go build, go vet, go test all pass clean
**Issues found:**
- None. Implementation was fully complete; uncommitted refactoring and tests from a prior session were validated and committed.
**Notes for next session:**
- T-008 is done and unblocks: T-021 (FFprobe media analysis endpoint, high, deps: T-008 ✅, T-019 ✅), T-022 (direct playback, high, deps: T-008 ✅, T-019 ✅)
- 12 tasks now done: T-003, T-004, T-006, T-007, T-008, T-010, T-015, T-018, T-019, T-035, T-036, T-039
- Next tasks with all deps satisfied:
  - T-012 (torrent lifecycle start/stop/focus, high, deps: T-007 ✅, T-010 ✅)
  - T-020 (HLS seek/watchdog/FSM, high, deps: T-019 ✅)
  - T-021 (FFprobe media analysis endpoint, high, deps: T-008 ✅, T-019 ✅) — NOW UNBLOCKED
  - T-022 (direct playback, high, deps: T-008 ✅, T-019 ✅) — NOW UNBLOCKED
  - T-027 (scaffold torrent-search, high, deps: [])
  - T-005 (middleware, medium, deps: T-003 ✅)
  - T-009 (settings repos, medium, deps: T-004 ✅)
  - T-011 (list view modes, medium, deps: T-010 ✅)
  - T-014 (SyncState, medium, deps: T-006 ✅, T-007 ✅)
  - T-016 (adaptive boosts, medium, deps: T-015 ✅)
  - T-017 (dormancy, medium, deps: T-015 ✅)
- Recommend T-012 next as it is high priority with lowest ID among unblocked high-priority tasks

## Iteration 12 — 2026-02-20 00:15
**Task:** [T-012] Implement torrent lifecycle: start, stop, focus with session state
**Status:** done
**What was done:**
- Verified all lifecycle operations already fully implemented — no code changes needed
- StartTorrent (start_torrent.go, 57 lines): fetches record from repo, calls engine.StartSession, falls back to openSessionFromRecord if session not found, updates status to TorrentActive, persists update
- StopTorrent (stop_torrent.go, 46 lines): fetches record, calls engine.StopSession (ignores ErrNotFound for idempotency), updates status to TorrentStopped
- GetTorrentState + ListActiveTorrentStates (state_torrent.go, 53 lines): single state via engine.GetSessionState returning full SessionState (ID, Status, Mode, Progress, Peers, DownloadSpeed, UploadSpeed, Files, NumPieces, PieceBitfield, UpdatedAt); list via engine.ListActiveSessions with per-session state fetch
- SessionMode state machine in domain: 6 modes (Idle/Downloading/Focused/Paused/Stopped/Completed) with correct transitions per PRD 4.1
- Focus handler (handlers_torrents.go line 646): sets current torrent via player settings controller or engine.FocusSession, auto-starts if not active
- Unfocus handler (handlers_torrents.go line 666): clears via engine.UnfocusAll
- All endpoints wired: POST /torrents/{id}/start (line 398), POST /torrents/{id}/stop (line 413), POST /torrents/{id}/focus (line 646), POST /torrents/unfocus (line 666), GET /torrents/{id}/state (line 608), GET /torrents/state?status=active (line 623)
- Bulk start/stop also implemented (lines 499-549)
- 15 use case tests pass: StartTorrent (happy + not found + engine error + repo update error + repo get error), StopTorrent (happy + not found + repo get error + engine error + repo update error + engine-not-found-ignored), GetTorrentState (happy + not found), ListActiveTorrentStates (happy + engine error)
- 10+ HTTP handler tests pass: start/stop/focus/unfocus/state endpoints + bulk operations + edge cases
- go build, go vet, go test ./... all pass clean (0 failures)
**Issues found:**
- None. Implementation was fully complete with comprehensive test coverage.
**Notes for next session:**
- T-012 is done and unblocks: T-013 (bulk operations + tag management, medium, deps: T-012 ✅)
- 13 tasks now done: T-003, T-004, T-006, T-007, T-008, T-010, T-012, T-015, T-018, T-019, T-035, T-036, T-039
- Next tasks with all deps satisfied:
  - T-020 (HLS seek/watchdog/FSM, high, deps: T-019 ✅)
  - T-021 (FFprobe media analysis endpoint, high, deps: T-008 ✅, T-019 ✅)
  - T-022 (direct playback, high, deps: T-008 ✅, T-019 ✅)
  - T-027 (scaffold torrent-search, high, deps: [])
  - T-013 (bulk operations, medium, deps: T-012 ✅) — NOW UNBLOCKED
  - T-005 (middleware, medium, deps: T-003 ✅)
  - T-009 (settings repos, medium, deps: T-004 ✅)
  - T-011 (list view modes, medium, deps: T-010 ✅)
  - T-014 (SyncState, medium, deps: T-006 ✅, T-007 ✅)
  - T-016 (adaptive boosts, medium, deps: T-015 ✅)
  - T-017 (dormancy, medium, deps: T-015 ✅)
- Recommend T-020 next as it is high priority with lowest ID among unblocked high-priority tasks

## Iteration 13 — 2026-02-20 01:00
**Task:** [T-020] Implement HLS seek, watchdog, and FSM state management
**Status:** done
**What was done:**
- Verified all HLS seek, watchdog, and FSM functionality already fully implemented — no code changes needed
- Seek endpoint: POST /torrents/{id}/hls/{fileIndex}/seek?time=&audioTrack=&subtitleTrack= returns JSON {seekTime, seekMode}
- Soft seek: within 2×segDur or forward gap < 12s restart cost → returns existing job, no FFmpeg restart
- Hard seek: kills old FFmpeg, creates new job directory, starts new StreamJob from byte offset, anti-seek-storm (150ms debounce), pre-boosts priority
- Subtitle fallback: retries without subtitles if subtitle source unavailable during seek
- FSM (streaming_fsm.go, 798 lines): 8 states (Idle/Loading/Ready/Playing/Buffering/Seeking/Completed/Error), run() loop with doLoading/doReady/doPlaying/doBuffering/doSeeking
- Watchdog (doPlaying): 5s interval, L1 escalation at 30s (priority boost), L2 at 60s (→Buffering), hard stall at 90s/5min (→Error)
- doBuffering: enhanced priority, 3s poll, 90s timeout, seek check
- 19 test functions covering seek mode, FSM states, watchdog behavior, HTTP handler edge cases
- go build, go vet, go test ./... all pass clean (0 failures)
**Issues found:**
- None. Implementation was fully complete with comprehensive test coverage.
**Notes for next session:**
- T-020 is done and unblocks: (no direct dependents in tasks.json)
- 14 tasks now done: T-003, T-004, T-006, T-007, T-008, T-010, T-012, T-015, T-018, T-019, T-020, T-035, T-036, T-039
- Next tasks with all deps satisfied:
  - T-021 (direct browser playback, medium, deps: T-008 ✅, T-018 ✅)
  - T-022 (direct playback, high, deps: T-008 ✅, T-019 ✅) — check actual deps
  - T-027 (scaffold torrent-search, high, deps: [])
  - T-005 (middleware, medium, deps: T-003 ✅)
  - T-009 (settings repos, medium, deps: T-004 ✅)
  - T-011 (list view modes, medium, deps: T-010 ✅)
  - T-013 (bulk operations, medium, deps: T-012 ✅)
  - T-014 (SyncState, medium, deps: T-006 ✅, T-007 ✅)
  - T-016 (adaptive boosts, medium, deps: T-015 ✅)
  - T-017 (dormancy, medium, deps: T-015 ✅)
- Recommend T-027 next as it is high priority with no dependencies, or T-022 if deps are met
