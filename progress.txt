# Progress Log — T◎RRX

Each iteration appends a structured entry.
The coding agent reads this file at the start of every session to understand what has been done.

Format:
```
## Iteration [N] — [YYYY-MM-DD HH:MM]
**Task:** [T-XXX] [title]
**Status:** done | in_progress | blocked
**What was done:**
- ...
**Issues found:**
- ... (or "None")
**Notes for next session:**
- ...
```

---

## Iteration 1 — 2026-02-19 12:00
**Task:** [T-004] Implement domain layer with value objects and port interfaces
**Status:** done
**What was done:**
- Verified all domain value objects exist and match PRD: TorrentRecord, TorrentStatus (5 states), TorrentSource, FileRef, SessionMode (6 states + state machine), SessionState, Priority (-1 to 4), MediaInfo, MediaTrack, WatchPosition, TorrentFilter, Range
- Verified all port interfaces: Engine (14 methods), TorrentRepository (8 methods), Session (7 methods), Storage (6 methods), StreamReader (6 methods including io.ReadSeekCloser), Scheduler (2 methods)
- Verified domain error types: ErrNotFound, ErrUnsupported, ErrAlreadyExists, ErrInvalidTransition
- Verified domain purity: no external imports in domain package (only stdlib errors, time)
- Verified go vet passes clean on ./internal/domain/...
- Added missing test: TorrentPending status constant test
- Added 30-case table-driven TestCanTransition covering all 6 SessionMode states (valid + invalid transitions)
- Added 7-case TestToStatus verifying SessionMode-to-TorrentStatus mapping including unknown mode
- Added 13-case table-driven TestTorrentRecordValidate (valid, empty ID, empty status, invalid status, negative bytes, overflow, boundary cases, all 5 statuses)
- Added TestWatchPositionJSONTags, TestMediaInfoJSONTags, TestMediaTrackJSONTags
- Added TestStreamReaderInterface verifying all 6 methods (Read, Seek, Close from io.ReadSeekCloser + SetContext, SetReadahead, SetResponsive)
- All tests pass (56 domain test cases total)
**Issues found:**
- None. Domain layer was fully implemented; tests had gaps that are now filled.
**Notes for next session:**
- T-004 is done and unblocks: T-007 (anacrolix engine adapter), T-015 (SlidingPriorityReader), T-006 (MongoDB repo), T-009 (settings repos), T-024 (watch history)
- T-003 (scaffold) is also ready to verify — Go module, config, HTTP server, health endpoint all exist
- Consider T-007 or T-003 next as they are critical priority with T-004 dependency now satisfied

## Iteration 2 — 2026-02-19 14:00
**Task:** [T-003] Scaffold torrent-engine project with config and HTTP server
**Status:** done
**What was done:**
- Verified go.mod: module `torrentstream`, Go 1.25.5, all dependencies present
- Verified cmd/server/main.go (394 lines): full HTTP server with net/http.ServeMux (25+ routes), graceful shutdown on SIGTERM/SIGINT with 10s timeout, ordered component teardown (HLS manager → HTTP server → engine → MongoDB → tracer)
- Verified internal/app/config.go: parses all 22 PRD 9.1 env vars — 21 in config.go (HTTP_ADDR, MONGO_URI, MONGO_DB, MONGO_COLLECTION, TORRENT_DATA_DIR, TORRENT_MAX_SESSIONS, TORRENT_MIN_DISK_SPACE_BYTES, FFMPEG_PATH, FFPROBE_PATH, HLS_DIR, HLS_PRESET, HLS_CRF, HLS_AUDIO_BITRATE, HLS_SEGMENT_DURATION, HLS_RAMBUF_SIZE_MB, HLS_PREBUFFER_MB, HLS_WINDOW_BEFORE_MB, HLS_WINDOW_AFTER_MB, CORS_ALLOWED_ORIGINS, LOG_LEVEL, LOG_FORMAT) + OTEL_EXPORTER_OTLP_ENDPOINT in telemetry.go
- Verified health endpoint: GET /internal/health/player returns JSON with status, sessions, HLS diagnostics, issues array
- Verified middleware stack: CORS (whitelist-based), rate-limit (100 RPS/200 burst, skips health/metrics), panic recovery, structured logging, OTEL tracing
- Created internal/app/config_test.go with 6 table-driven test functions (42+ sub-tests):
  - TestLoadConfigDefaults: verifies all 22 fields have correct defaults
  - TestLoadConfigFromEnv: verifies all fields read from environment correctly
  - TestGetEnvInt64InvalidFallsBack: 7 edge cases (empty, NaN, negative, zero, valid, whitespace, float)
  - TestParseCSV: 7 edge cases (empty, whitespace, single, multiple, spaces, trailing comma, empty entries)
  - TestGetEnvFallback: existing vs missing env var
  - TestLogLevelCaseInsensitive: LOG_LEVEL case normalization
- go build ./cmd/server/ — success with zero errors
- go vet ./... — clean, zero warnings
- go test ./... — all packages pass (14 packages, no failures)
**Issues found:**
- None. Scaffold was fully implemented; only config tests were missing.
**Notes for next session:**
- T-003 is done and unblocks: T-005 (middleware), T-010 (torrent CRUD), T-019 (HLS pipeline), T-022 (direct playback), T-023 (settings API), T-024 (watch history), T-025 (WebSocket), T-026 (metrics/swagger), T-050 (OTEL tracing)
- Both T-003 and T-004 are now done. Next critical tasks with all deps satisfied:
  - T-007 (anacrolix engine adapter, critical, deps: T-004 ✅)
  - T-015 (SlidingPriorityReader, critical, deps: T-004 ✅)
  - T-006 (MongoDB repo, high, deps: T-004 ✅)
  - T-005 (middleware, medium, deps: T-003 ✅)
  - T-008 (FFprobe adapter, high, deps: T-004 ✅)
- Recommend T-007 next as it is critical priority and unblocks T-010 and T-018

## Iteration 3 — 2026-02-19 16:00
**Task:** [T-007] Implement anacrolix/torrent engine adapter
**Status:** done
**What was done:**
- Verified all 14 Engine port methods implemented: Open, Close, GetSessionState, GetSession, ListActiveSessions, StopSession, StartSession, RemoveSession, SetPiecePriority, ListSessions, FocusSession, UnfocusAll, GetSessionMode, SetDownloadRateLimit
- Verified Session implements all 7 port methods: ID, Files, SelectFile, SetPiecePriority, Start, Stop, NewReader
- Verified AddMagnet returns TorrentID as info hash hex string
- Verified NewReader returns anacrolix torrent.Reader satisfying ports.StreamReader (io.ReadSeekCloser + SetContext, SetReadahead, SetResponsive)
- Verified Focus mode: hardPauseTorrent sets DisallowDataDownload+DisallowDataUpload+SetMaxEstablishedConns(0) on non-focused torrents; resumeTorrentForStreaming re-enables data on focused torrent without DownloadAll
- Fixed defaultMaxConns from 55 to 35 per PRD specification
- Initialized focusedPieces map in New() and NewWithClient() for consistency with other map fields
- Created engine_unit_test.go with comprehensive table-driven tests (45 test cases total):
  - TestDefaultMaxConnsIs35: verifies PRD-compliant value
  - TestMapPriority: 7 cases (None, Low, Normal, Readahead, Next, High, unknown default)
  - TestTransitionValid: 18 cases covering all valid state machine transitions
  - TestTransitionInvalid: 12 cases covering all invalid transitions
  - TestTransitionSameStateIsNoop: verifies same-state is no-op
  - TestTransitionUnknownSession: verifies ErrSessionNotFound
  - TestTransitionUpdatesFocusedID: verifies focusedID cache set/clear
  - TestTransitionFocusSwitchUpdatesCache: verifies focus switch between torrents
  - TestEvictIdleSessionLocked: 4 cases (empty, LRU idle, focused protected, prefers idle)
  - TestGetSessionMode: 2 cases (not found, correct mode)
  - TestListSessions: 2 cases (empty, returns all)
  - TestListActiveSessions: excludes stopped/completed, includes active/paused
  - TestSetDownloadRateLimit: not found + get rate limit
  - TestSession*: 8 cases (ID, defensive copy, nil torrent, file selection, nil reader, nil engine)
  - TestSampleSpeedNegativeDeltaClamped: counter reset handling
  - TestStoreFocusedPieces/ForgetFocusedPieces: 4 cases (zero range, valid, cleanup, nil map)
  - TestCloseNilClient, TestTouchLastAccess: 3 edge cases
- go vet ./... — clean, zero warnings
- go test ./... — all 14 packages pass (0 failures)
**Issues found:**
- defaultMaxConns was 55 (anacrolix default) instead of 35 (PRD spec) — fixed
- focusedPieces map not initialized in constructors (inconsistent with other maps) — fixed
**Notes for next session:**
- T-007 is done and unblocks: T-010 (torrent CRUD, critical), T-012 (torrent lifecycle, high), T-018 (stream torrent, critical)
- T-003, T-004, T-007 are all done. Next critical tasks with all deps satisfied:
  - T-015 (SlidingPriorityReader, critical, deps: T-004 ✅)
  - T-006 (MongoDB repo, high, deps: T-004 ✅) — needed by T-010 and T-014
  - T-008 (FFprobe adapter, high, deps: T-004 ✅) — needed by T-021 and T-022
  - T-005 (middleware, medium, deps: T-003 ✅)
  - T-009 (settings repos, medium, deps: T-004 ✅)
- T-010 (torrent CRUD, critical) needs T-003 ✅, T-006 ❌, T-007 ✅ — T-006 is the remaining blocker
- Recommend T-006 (MongoDB repo) next to unblock T-010, or T-015 (SlidingPriorityReader) as standalone critical task

## Iteration 4 — 2026-02-19 18:00
**Task:** [T-006] Implement MongoDB torrent repository adapter
**Status:** done
**What was done:**
- Verified all 8 TorrentRepository port methods already implemented: Create, Update, UpdateProgress, Get, List, GetMany, Delete, UpdateTags
- Verified compile-time interface compliance check in interface_test.go
- Verified implementation details: BSON document models (torrentDoc, torrentUpdateDoc, fileDoc), toDoc/fromDoc conversion, normalizeTags case-insensitive dedup, mongoSortField mapping, progressOfRecord calculation, cached progress field (0.0-1.0) for efficient DB sorting
- Verified EnsureIndexes creates all 5 PRD indexes: text on name, tags, createdAt, updatedAt, progress
- Verified UpdateProgress uses atomic $max on doneBytes to prevent concurrent regression
- Verified List supports status filter, case-insensitive regex search (QuoteMeta for special chars), multi-tag AND filter ($all), sort by name/createdAt/updatedAt/totalBytes/progress, pagination via limit/offset
- Wrote 42 unit tests (table-driven, no MongoDB required):
  - TestToDocFromDocRoundtrip: full field roundtrip
  - TestToDocWithTorrentFileSource: .torrent source path
  - TestToDocEmptyFiles: empty files slice
  - TestToDocProgress: 5 cases (zero total, zero done, half, complete, large file)
  - TestToUpdateDocOmitsID: _id excluded from update doc
  - TestToUpdateDocPreservesProgress: progress calculation
  - TestToUpdateDocAllFieldsPresent: all 11 required fields
  - TestNormalizeTags: 9 cases (nil, empty, single, case-insensitive dedup, whitespace, empty removal, order, mixed, all-empty)
  - TestMongoSortField: 8 cases (5 valid fields, unknown, empty, case-sensitive)
  - TestProgressOfRecord: 6 cases (zero, negative, done, half, complete, overflow)
  - TestTimeFromUnix: 3 cases (epoch, specific, recent)
  - TestFromDocsEmpty, TestFromDocsMultiple: edge cases
  - TestToDocBSONRoundtrip: BSON serialize/deserialize integrity
  - TestToDocIDMappedTo_id: _id BSON tag mapping
  - TestEnsureIndexesNilRepository, TestEnsureIndexesNilCollection: nil safety
- Wrote 31 integration tests against real MongoDB (skip if unavailable):
  - CRUD: Create, CreateDuplicate(ErrAlreadyExists), GetRoundtrip(all fields), GetNotFound, Update, UpdateNotFound, Delete, DeleteNotFound
  - UpdateProgress: forward, $max regression (lower value preserved), higher value, NotFound, WithFiles, CachesProgressField
  - List: All, FilterStatus, Search, SearchCaseInsensitive, SearchSpecialChars, FilterTags(single+multi-AND), SortByName, SortByProgress, SortDefaultDesc, Pagination, CombinedFilters, UnknownSortFieldFallsBack
  - GetMany: normal, empty, partial match
  - UpdateTags: normal, NotFound, Normalized
  - EnsureIndexes: idempotency + 6 index verification
- go vet clean, go test ./... all 8 test packages pass (0 failures)
**Issues found:**
- None. Implementation was fully complete; only comprehensive tests were missing.
**Notes for next session:**
- T-006 is done and unblocks: T-010 (torrent CRUD, critical, deps: T-003 ✅, T-006 ✅, T-007 ✅), T-014 (SyncState, medium)
- T-003, T-004, T-006, T-007 all done. T-010 is now fully unblocked (all 3 deps satisfied)
- Next critical tasks with all deps satisfied:
  - T-010 (torrent CRUD vertical slice, critical, deps: T-003 ✅, T-006 ✅, T-007 ✅) — NOW UNBLOCKED
  - T-015 (SlidingPriorityReader, critical, deps: T-004 ✅)
  - T-008 (FFprobe adapter, high, deps: T-004 ✅) — needed by T-021 and T-022
  - T-005 (middleware, medium, deps: T-003 ✅)
  - T-009 (settings repos, medium, deps: T-004 ✅)
- Recommend T-010 next as it is now fully unblocked and is the critical torrent CRUD vertical slice
